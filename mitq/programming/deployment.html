<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Rail+NGinx+PostgreSQL+Redis setup</title>
        <link rel="alternate" type="application/rss+xml" title="AV notes" href="../../rss.xml" />
        <link rel="shortcut icon" href="../../favicon.ico?v=2" type="image/x-icon" />
        <link rel="stylesheet" href="../../css/bootstrap.min.css" />
        <link rel="stylesheet" href="../../css/bootstrap-theme.min.css" />
        <link rel="stylesheet" href="../../css/default.css" />
        <link rel="stylesheet" href="../../css/syntax.css" />
          <link rel="stylesheet" href="../../css/quotes.css" />
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( { tex2jax: { inlineMath: [ ["\\(", "\\)"] ]
                                           , displayMath: [ ["\\[", "\\]" ] ]
                                           , processEscapes: true
                                           }
                              });



        </script>
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>

        <script type="text/javascript" src="../../js/jquery.min.js">
        </script>
        <script type="text/javascript" src="../../js/bootstrap.min.js">
        </script>
        <script type="text/javascript" src="../../js/codeCopy.js">
        </script>

    </head>
    <body>
        <div class="container">


            <div id="header">

                <ul id="navigation" class="list-inline text-center">
                    <li class="logo"><a href="../../" class="home-link">ԳԼԽԱՎՈՐ</a></i>
                    <li><a href="../../hogi/">ՀՈԳԻ</a></li>
                    <li><a href="../../mitq/">ՄԻՏՔ</a></li>
                    <li><a href="../../marmin/">ՄԱՐՄԻՆ</a></li>
                    <li><a href="../../rss.xml"><i class="fa fa-rss"></i></a></li>
                    <!-- <li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li> -->
                </ul>
            </div>
            <div class="clear"></div>
            <!---->

  <div class="clear"></div>
<!--  <p style="font-size: 11px;"><strong>Ուշադրություն.</strong> <small>«իմաստասէր» բառը պետք է հասկանալ տառացի. ոչ որպէս փիլիսոփա իմաստով:</small></p> -->
            <div id="content">

               <!-- <div class="title text-center">
                    <h4>Rail+NGinx+PostgreSQL+Redis setup</h4>
                    <hr>
                </div> -->
                <div class="post-content">
<div id="TOC"><ul>
<li><a href="#todo">TODO</a></li>
<li><a href="#create-ssh-key-for-remote-server">create ssh key for remote server</a></li>
<li><a href="#server-fingerprint-changes">server fingerprint changes</a></li>
<li><a href="#create-user">create user</a></li>
<li><a href="#nginx">Nginx</a></li>
<li><a href="#set-domain-or-subdomain">set domain or subdomain</a></li>
<li><a href="#lets-encrypt">Let’s Encrypt</a></li>
<li><a href="#ruby-nodejs-go-rails-instruction">Ruby, Nodejs, <span>Go rails instruction</span></a></li>
<li><a href="#postgresql">PostgreSQL</a><ul>
<li><a href="#postgresql-hacks">postgresql hacks</a></li>
</ul></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#mina">Mina</a><ul>
<li><a href="#install-mina-gem">install mina gem</a></li>
</ul></li>
<li><a href="#some-commands-with-no-password">some commands with no password</a><ul>
<li><a href="#deploy-with-mina">deploy with mina</a></li>
</ul></li>
<li><a href="#backup-gem">Backup gem</a></li>
<li><a href="#cron">CRON</a><ul>
<li><a href="#activate-log-for-cron-jobs">activate log for cron jobs</a></li>
</ul></li>
<li><a href="#convert-putty-to-ssh-agent">Convert putty to ssh-agent</a></li>
<li><a href="#linux-commands">Linux commands</a><ul>
<li><a href="#folder-size">folder size</a></li>
<li><a href="#system.d">system.d</a></li>
<li><a href="#logs">logs</a></li>
<li><a href="#bash">bash</a></li>
</ul></li>
</ul></div>
<section id="todo" class="level1">
<h1>TODO</h1>
<ul>
<li>Backup Letsencrypt folder</li>
<li>backup config files move to shared folder</li>
</ul>
</section>
<section id="create-ssh-key-for-remote-server" class="level1">
<h1>create ssh key for remote server</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">ssh-keygen</span> -t rsa</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">cat</span> ~/.ssh/<span class="op">&lt;</span>ssh_file_name<span class="op">&gt;</span>.pub</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">ssh</span> user@<span class="op">&lt;</span>ip<span class="op">&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># check for key in server</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">cat</span> ~/.ssh/authorized_keys</span></code></pre></div>
</section>
<section id="server-fingerprint-changes" class="level1">
<h1>server fingerprint changes</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">ssh-keygen</span> -f <span class="st">&quot;/home/arthur/.ssh/known_hosts&quot;</span> -R <span class="op">&lt;</span>ip_address<span class="op">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">ssh-keygen</span> -f <span class="st">&quot;/home/arthur/.ssh/known_hosts&quot;</span> -R <span class="op">&lt;</span>domain_name<span class="op">&gt;</span></span></code></pre></div>
</section>
<section id="create-user" class="level1">
<h1>create user</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">adduser</span> deployer</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">sudo</span> usermod -aG sudo deployer</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="fu">mkdir</span> /home/deployer/.ssh</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="fu">cp</span> .ssh/authorized_keys /home/deployer/.ssh/</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="fu">sudo</span> chown -R deployer:deployer /home/deployer/.ssh/</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co"># edit file</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="fu">sudo</span> vi /etc/ssh/sshd_config</span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="ex">...</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="ex">PasswordAuthentication</span> no</span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="ex">...</span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co"># allow from some hosts</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="co"># Settings that override the global settings for matching IP addresses only</span></span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="ex">Match</span> address 192.0.2.0/24</span>
<span id="cb3-15"><a href="#cb3-15"></a>  <span class="ex">PasswordAuthentication</span> yes</span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="ex">service</span> ssh reload</span>
<span id="cb3-17"><a href="#cb3-17"></a></span>
<span id="cb3-18"><a href="#cb3-18"></a><span class="co"># on remote server check permission and set to if needed</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="co"># chmod 700 .ssh</span></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="co"># chmod 600 .ssh/authorized_keys</span></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="bu">logout</span></span>
<span id="cb3-22"><a href="#cb3-22"></a><span class="fu">ssh</span> deployer@<span class="op">&lt;</span>ip_adddress<span class="op">&gt;</span></span></code></pre></div>
</section>
<section id="nginx" class="level1">
<h1>Nginx</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># https://websiteforstudents.com/install-nginx-latest-version-ubuntu-16-10-17-04/</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># For the stable version, change mainline to stable.</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">sudo</span> sh -c <span class="st">'echo &quot;deb http://nginx.org/packages/mainline/ubuntu/ `lsb_release -cs` nginx&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list'</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="fu">sudo</span> sh -c <span class="st">'echo &quot;deb-src http://nginx.org/packages/mainline/ubuntu/ `lsb_release -cs` nginx&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list'</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="fu">wget</span> -q http://nginx.org/keys/nginx_signing.key -O - <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="fu">sudo</span> apt -y update</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="ex">apt-cache</span> policy nginx</span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="fu">sudo</span> apt install -y nginx</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="ex">nginx</span> -v</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="fu">sudo</span> systemctl enable nginx</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="fu">sudo</span> service nginx start</span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="ex">systemctl</span> status nginx</span></code></pre></div>
</section>
<section id="set-domain-or-subdomain" class="level1">
<h1>set domain or subdomain</h1>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># add A-record to dns server</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">sudo</span> vi  /etc/hosts</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ex">127.0.1.1</span> test.<span class="op">&lt;</span>domain_name<span class="op">&gt;</span> test</span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="ex">127.0.0.1</span> localhost</span></code></pre></div>
</section>
<section id="lets-encrypt" class="level1">
<h1>Let’s Encrypt</h1>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a> <span class="co"># it is easy to get certificate before you have the advacned nginx config for</span></span>
<span id="cb6-2"><a href="#cb6-2"></a> <span class="co"># your site</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="fu">sudo</span> add-apt-repository ppa:certbot/certbot</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="fu">sudo</span> apt update -y</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="fu">sudo</span> apt install -y python-certbot-nginx</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="fu">sudo</span> systemctl reload nginx</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="ex">verify</span> the syntax of configurations</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="fu">sudo</span> nginx -t</span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="fu">sudo</span> certbot certonly --dry-run --nginx -d <span class="op">&lt;</span>domain_name<span class="op">&gt;</span> -d www.<span class="op">&lt;</span>domain_name<span class="op">&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: backup /etc/letsencrypt fodler</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co"># configuration directory at /etc/letsencrypt. You should make a</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co"># secure backup of this folder now. This configuration directory will</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co"># also contain certificates and private keys obtained by Certbot so</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co"># making regular backups of this folder is ideal.</span></span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co"># at first comment ssl parts from nginx config for the site we want to get  certificate</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: generate pre-certifiacation config for site</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co"># enter email address, c - is canceling all process.</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="fu">sudo</span> certbot --nginx -d <span class="op">&lt;</span>domain_name<span class="op">&gt;</span> -d www.<span class="op">&lt;</span>domain_name<span class="op">&gt;</span></span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="fu">sudo</span> certbot renew --dry-run</span></code></pre></div>
</section>
<section id="ruby-nodejs-go-rails-instruction" class="level1">
<h1>Ruby, Nodejs, <a href="https://gorails.com/setup/ubuntu/16.04">Go rails instruction</a></h1>
<p>Nodejs</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">curl</span> -sL https://deb.nodesource.com/setup_10.x <span class="kw">|</span> <span class="fu">sudo</span> -E bash -</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">sudo</span> apt -y update</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">sudo</span> apt -y install git-core curl zlib1g-dev build-essential libssl-dev</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">sudo</span> apt -y install  libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="fu">sudo</span> apt -y install  libcurl4-openssl-dev libffi-dev nodejs</span></code></pre></div>
<p>Yarn</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">curl</span> -sL https://dl.yarnpkg.com/debian/pubkey.gpg <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="bu">echo</span> <span class="st">&quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span> <span class="kw">|</span> <span class="fu">sudo</span> tee /etc/apt/sources.list.d/yarn.list</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">sudo</span> apt-get update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt-get install yarn</span></code></pre></div>
<p>rbenv</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="bu">cd</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">git</span> clone https://github.com/rbenv/rbenv.git ~/.rbenv</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="bu">echo</span> <span class="st">'export PATH=&quot;$HOME/.rbenv/bin:$PATH&quot;'</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="bu">echo</span> <span class="st">'eval &quot;$(rbenv init -)&quot;'</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="bu">exec</span> <span class="va">$SHELL</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="fu">git</span> clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build</span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="bu">echo</span> <span class="st">'export PATH=&quot;$HOME/.rbenv/plugins/ruby-build/bin:$PATH&quot;'</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="bu">exec</span> <span class="va">$SHELL</span></span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="ex">rbenv</span> install 2.5.1</span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="ex">rbenv</span> global 2.5.1</span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="ex">ruby</span> -v</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="bu">echo</span> <span class="st">&quot;gem: --no-document&quot;</span> <span class="op">&gt;</span> ~/.gemrc</span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="ex">gem</span> install bundler</span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="ex">rbenv</span> rehash</span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="ex">gem</span> list rails</span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="ex">gem</span> env home</span>
<span id="cb9-20"><a href="#cb9-20"></a></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="co"># Commands</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="ex">rbenv</span> install -l <span class="co"># list of versions that you can choose to install.</span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="ex">rbenv</span> versions <span class="co"># Lists all Ruby versions known to rbenv</span></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="ex">rbenv</span> version <span class="co"># Displays the currently active Ruby version</span></span></code></pre></div>
</section>
<section id="postgresql" class="level1">
<h1>PostgreSQL</h1>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">sudo</span> sh -c <span class="st">'echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main&quot; &gt;&gt; /etc/apt/sources.list.d/pgdg.list'</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">wget</span> -q https://www.postgresql.org/media/keys/ACCC4CF8.asc -O - <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">sudo</span> apt update -y</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="fu">sudo</span> apt -y install postgresql postgresql-contrib libpq-dev</span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co"># add user auth</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="fu">sudo</span> vi /etc/postgresql/10//main/pg_hba.conf</span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="bu">local</span>   <span class="op">&lt;</span><span class="ex">db_name</span><span class="op">&gt;</span> <span class="op">&lt;</span>user_role<span class="op">&gt;</span> md5</span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="fu">sudo</span> systemctl status  postgresql</span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="fu">sudo</span> systemctl enable  postgresql</span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="fu">sudo</span> systemctl restart postgresql</span></code></pre></div>
<p>create db user, set postgres password</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">sudo</span> su postgres</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="ex">psql</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co"># set password for psotgres</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>\<span class="ex">password</span> --</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co"># &lt;your_password for super user&gt;</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="ex">create</span> user iot with password <span class="st">'yourpass'</span> createdb superuser<span class="kw">;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>\<span class="fu">du</span> -- list users</span>
<span id="cb11-8"><a href="#cb11-8"></a>\<span class="ex">q</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="bu">exit</span></span></code></pre></div>
<section id="postgresql-hacks" class="level2">
<h2>postgresql hacks</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="op">&gt;</span> <span class="ex">SELECT</span> pg_terminate_backend(pg_stat_activity.pid) <span class="ex">FROM</span> pg_stat_activity</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="ex">WHERE</span> pg_stat_activity.datname = <span class="st">'iothub_production;</span></span></code></pre></div>
</section>
</section>
<section id="redis" class="level1">
<h1>Redis</h1>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">---------Install</span> build and test dependencies: ------</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="fu">sudo</span> apt -y update</span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="fu">sudo</span> apt -y full-upgrade</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co"># make test required tcl to run</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="fu">sudo</span> apt-get -y install build-essential tcl</span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="ex">---------Set</span> up redis: -------</span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#Download latest copy via this link or with this</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="fu">mkdir</span> Downloads</span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="bu">cd</span> Downloads</span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="ex">curl</span> -O http://download.redis.io/redis-stable.tar.gz</span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="fu">tar</span> xzvf redis-stable.tar.gz</span>
<span id="cb13-13"><a href="#cb13-13"></a></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="bu">cd</span> redis-stable</span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="fu">make</span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="fu">sudo</span> make install</span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="fu">make</span> test</span>
<span id="cb13-18"><a href="#cb13-18"></a></span>
<span id="cb13-19"><a href="#cb13-19"></a><span class="ex">------</span> Configure redis: -------</span>
<span id="cb13-20"><a href="#cb13-20"></a><span class="co">#Create configuration directory:</span></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="fu">sudo</span> mkdir /etc/redis</span>
<span id="cb13-22"><a href="#cb13-22"></a><span class="co"># Move sample redis configuration file:</span></span>
<span id="cb13-23"><a href="#cb13-23"></a><span class="fu">sudo</span> cp ~/Downloads/redis-stable/redis.conf /etc/redis</span>
<span id="cb13-24"><a href="#cb13-24"></a><span class="fu">sudo</span> vi /etc/redis/redis.conf</span>
<span id="cb13-25"><a href="#cb13-25"></a><span class="co">#set dir for persistent data dump, for log</span></span>
<span id="cb13-26"><a href="#cb13-26"></a><span class="ex">supervised</span> systemd</span>
<span id="cb13-27"><a href="#cb13-27"></a><span class="fu">dir</span> /var/redis</span>
<span id="cb13-28"><a href="#cb13-28"></a><span class="ex">logfile</span> /var/redis/redis.log</span>
<span id="cb13-29"><a href="#cb13-29"></a></span>
<span id="cb13-30"><a href="#cb13-30"></a><span class="ex">------</span> Set up the systemd unit file:------</span>
<span id="cb13-31"><a href="#cb13-31"></a><span class="co">#create file</span></span>
<span id="cb13-32"><a href="#cb13-32"></a><span class="fu">sudo</span> vi /etc/systemd/system/redis.service</span>
<span id="cb13-33"><a href="#cb13-33"></a></span>
<span id="cb13-34"><a href="#cb13-34"></a><span class="co"># add to file</span></span>
<span id="cb13-35"><a href="#cb13-35"></a>[<span class="ex">Unit</span>]</span>
<span id="cb13-36"><a href="#cb13-36"></a><span class="va">Description=</span>Redis <span class="ex">In-Memory</span> Data Store</span>
<span id="cb13-37"><a href="#cb13-37"></a><span class="va">After=</span>network.target</span>
<span id="cb13-38"><a href="#cb13-38"></a></span>
<span id="cb13-39"><a href="#cb13-39"></a>[<span class="ex">Service</span>]</span>
<span id="cb13-40"><a href="#cb13-40"></a><span class="va">User=</span>redis</span>
<span id="cb13-41"><a href="#cb13-41"></a><span class="va">Group=</span>redis</span>
<span id="cb13-42"><a href="#cb13-42"></a><span class="va">ExecStart=</span>/usr/local/bin/redis-server <span class="ex">/etc/redis/redis.conf</span></span>
<span id="cb13-43"><a href="#cb13-43"></a><span class="va">ExecStop=</span>/usr/local/bin/redis-cli <span class="ex">shutdown</span></span>
<span id="cb13-44"><a href="#cb13-44"></a><span class="va">Restart=</span>always</span>
<span id="cb13-45"><a href="#cb13-45"></a></span>
<span id="cb13-46"><a href="#cb13-46"></a>[<span class="ex">Install</span>]</span>
<span id="cb13-47"><a href="#cb13-47"></a><span class="va">WantedBy=</span>multi-user.target</span>
<span id="cb13-48"><a href="#cb13-48"></a></span>
<span id="cb13-49"><a href="#cb13-49"></a><span class="ex">-----</span>––––-----–– Set up redis user, groups and directories: –––</span>
<span id="cb13-50"><a href="#cb13-50"></a><span class="co"># if /etc/systemd/system/redis.service cahnged</span></span>
<span id="cb13-51"><a href="#cb13-51"></a><span class="fu">sudo</span> systemctl daemon-reload</span>
<span id="cb13-52"><a href="#cb13-52"></a><span class="co"># create redis user and group with same ID but no home directory:</span></span>
<span id="cb13-53"><a href="#cb13-53"></a></span>
<span id="cb13-54"><a href="#cb13-54"></a><span class="fu">sudo</span> adduser --system --group --no-create-home redis</span>
<span id="cb13-55"><a href="#cb13-55"></a><span class="fu">sudo</span> mkdir /var/redis   <span class="co"># create directory</span></span>
<span id="cb13-56"><a href="#cb13-56"></a><span class="fu">sudo</span> chown redis:redis /var/redis   <span class="co"># make redis own /var/redis</span></span>
<span id="cb13-57"><a href="#cb13-57"></a><span class="fu">sudo</span> chmod 770 /var/redis   <span class="co"># adjust permission</span></span>
<span id="cb13-58"><a href="#cb13-58"></a></span>
<span id="cb13-59"><a href="#cb13-59"></a><span class="fu">sudo</span> systemctl enable redis <span class="co"># Enable redis to start at boot:</span></span>
<span id="cb13-60"><a href="#cb13-60"></a><span class="fu">sudo</span> systemctl start redis</span>
<span id="cb13-61"><a href="#cb13-61"></a></span>
<span id="cb13-62"><a href="#cb13-62"></a><span class="co">#other commands</span></span>
<span id="cb13-63"><a href="#cb13-63"></a><span class="ex">systemctl</span> status redis</span>
<span id="cb13-64"><a href="#cb13-64"></a><span class="fu">sudo</span> systemctl restart redis</span>
<span id="cb13-65"><a href="#cb13-65"></a></span>
<span id="cb13-66"><a href="#cb13-66"></a><span class="ex">-------</span> Enable redis to start at boot:------</span>
<span id="cb13-67"><a href="#cb13-67"></a><span class="fu">sudo</span> systemctl enable redis</span>
<span id="cb13-68"><a href="#cb13-68"></a></span>
<span id="cb13-69"><a href="#cb13-69"></a><span class="ex">-----------------</span> Test instance: ------------</span>
<span id="cb13-70"><a href="#cb13-70"></a><span class="ex">redis-cli</span></span>
<span id="cb13-71"><a href="#cb13-71"></a><span class="fu">ping</span></span>
<span id="cb13-72"><a href="#cb13-72"></a><span class="kw">set</span> <span class="bu">test</span> <span class="st">&quot;It's working!&quot;</span></span>
<span id="cb13-73"><a href="#cb13-73"></a><span class="ex">get</span> test</span>
<span id="cb13-74"><a href="#cb13-74"></a><span class="bu">exit</span></span>
<span id="cb13-75"><a href="#cb13-75"></a><span class="fu">sudo</span> systemctl restart redis</span>
<span id="cb13-76"><a href="#cb13-76"></a><span class="ex">--</span>–– FIX Warnings ––-</span>
<span id="cb13-77"><a href="#cb13-77"></a></span>
<span id="cb13-78"><a href="#cb13-78"></a><span class="ex">---</span> WARNING overcommit_memory is set to 0</span>
<span id="cb13-79"><a href="#cb13-79"></a><span class="ex">--</span> fix warning</span>
<span id="cb13-80"><a href="#cb13-80"></a><span class="fu">sudo</span> vi /etc/sysctl.conf</span>
<span id="cb13-81"><a href="#cb13-81"></a><span class="ex">vm.overcommit_memory</span>=1</span>
<span id="cb13-82"><a href="#cb13-82"></a></span>
<span id="cb13-83"><a href="#cb13-83"></a><span class="co"># run on trminal as well</span></span>
<span id="cb13-84"><a href="#cb13-84"></a><span class="fu">sudo</span> sysctl vm.overcommit_memory=1</span>
<span id="cb13-85"><a href="#cb13-85"></a></span>
<span id="cb13-86"><a href="#cb13-86"></a><span class="ex">---</span> The TCP backlog setting of 511 cannot be enforced because</span>
<span id="cb13-87"><a href="#cb13-87"></a><span class="ex">----</span> /proc/sys/net/core/somaxconn is set to the lower value of 128</span>
<span id="cb13-88"><a href="#cb13-88"></a></span>
<span id="cb13-89"><a href="#cb13-89"></a><span class="fu">sudo</span> vi /etc/rc.local</span>
<span id="cb13-90"><a href="#cb13-90"></a><span class="ex">sysctl</span> -w net.core.somaxconn=65535</span>
<span id="cb13-91"><a href="#cb13-91"></a></span>
<span id="cb13-92"><a href="#cb13-92"></a><span class="co"># run on trminal as well</span></span>
<span id="cb13-93"><a href="#cb13-93"></a><span class="fu">sudo</span> sysctl -w net.core.somaxconn=65535</span></code></pre></div>
</section>
<section id="mina" class="level1">
<h1>Mina</h1>
<section id="install-mina-gem" class="level2">
<h2>install mina gem</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="ex">gem</span> instal mina</span></code></pre></div>
</section>
</section>
<section id="some-commands-with-no-password" class="level1">
<h1>some commands with no password</h1>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">sudo</span> vi /etc/sudoers</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co"># shift+G</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>ՈՒշադրություն, գրել վերջում</span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co"># IMPORTANT!!!  add at the end</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="ex">deployer</span> ALL=(ALL) <span class="ex">NOPASSWD</span>: /bin/ln</span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="ex">deployer</span> ALL=(ALL) <span class="ex">NOPASSWD</span>: /bin/chmod</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="ex">deployer</span> ALL=(ALL) <span class="ex">NOPASSWD</span>: /bin/cp</span>
<span id="cb15-8"><a href="#cb15-8"></a></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="co"># :wq!</span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="co"># https://github.com/mina-deploy/mina/issues/234#issuecomment-57242061</span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="fu">sudo</span> service ssh reload</span></code></pre></div>
<section id="deploy-with-mina" class="level2">
<h2>deploy with mina</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a><span class="op">&gt;</span> <span class="ex">mina</span> test setup</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="co"># at frist time uncomment schema_load, then comment</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="op">&gt;</span> <span class="ex">mina</span> test deploy</span></code></pre></div>
</section>
</section>
<section id="backup-gem" class="level1">
<h1>Backup gem</h1>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a><span class="ex">gem</span> install backup -v5.0.0.beta.2</span></code></pre></div>
</section>
<section id="cron" class="level1">
<h1>CRON</h1>
<section id="activate-log-for-cron-jobs" class="level2">
<h2>activate log for cron jobs</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">sudo</span> vi  /etc/rsyslog.d/50-default.conf</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="ex">/s</span> <span class="co">#cron</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co"># uncomment the line</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="ex">cron.*</span>                          /var/log/cron.log</span>
<span id="cb18-5"><a href="#cb18-5"></a></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="fu">sudo</span> service rsyslog restart</span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="fu">sudo</span> service cron restart</span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="co"># Cron activity will now be logged to /var/log/cron.log file (in addition to syslog).</span></span>
<span id="cb18-9"><a href="#cb18-9"></a></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co"># to continuously monitor it</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="fu">tail</span> -f /var/log/syslog <span class="kw">|</span> <span class="fu">grep</span> CRON</span>
<span id="cb18-12"><a href="#cb18-12"></a></span></code></pre></div>
</section>
</section>
<section id="convert-putty-to-ssh-agent" class="level1">
<h1>Convert putty to ssh-agent</h1>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># puttygen supports exporting your private key to an OpenSSH compatible format. You can then use OpenSSH tools to recreate the public key.</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co"># 1. Open PuttyGen</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co"># 2. Click Load</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co"># 3. Load your private key</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co"># 4. Go to Conversions-&gt;Export OpenSSH and export your private key</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co"># 5. Copy your private key to ~/.ssh/id_dsa (or id_rsa).</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co"># 6. Create the RFC 4716 version of the public key using ssh-keygen</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="fu">ssh-keygen</span> -e -f ~/.ssh/id_dsa <span class="op">&gt;</span> ~/.ssh/id_dsa_com.pub</span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co"># 7. Convert the RFC 4716 version of the public key to the OpenSSH format:</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="fu">ssh-keygen</span> -i -f ~/.ssh/id_dsa_com.pub <span class="op">&gt;</span> ~/.ssh/id_dsa.pub</span></code></pre></div>
</section>
<section id="linux-commands" class="level1">
<h1>Linux commands</h1>
<section id="folder-size" class="level2">
<h2>folder size</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># disk usage info</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="fu">df</span> -h --total</span>
<span id="cb20-3"><a href="#cb20-3"></a></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="co"># each folder size</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="fu">du</span> -sh * <span class="kw">|</span> <span class="fu">sort</span> -g</span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="fu">du</span> -sk * <span class="kw">|</span> <span class="fu">sort</span> -n</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co"># each folder size including hiddens</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="fu">du</span> -sch .[!.]* * <span class="kw">|</span><span class="fu">sort</span> -h</span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="co"># try ncdu</span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="fu">sudo</span> apt-get install ncdu</span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="ex">ncdu</span></span></code></pre></div>
</section>
<section id="system.d" class="level2">
<h2>system.d</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># nginx config test</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="fu">sudo</span> nginx -t</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="fu">sudo</span> nginx -t -c /etc/nginx/conf.d/taxicenter.conf</span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="co"># systemd</span></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co"># reload if unit file changed</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="fu">sudo</span> systemctl daemon-reload</span></code></pre></div>
</section>
<section id="logs" class="level2">
<h2>logs</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># read</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="fu">cat</span> /node-1.log <span class="kw">|</span> <span class="fu">head</span> -20</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="fu">tail</span> -f logs/node-1.log</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="ex">jq</span> select(.ns[1]==<span class="st">&quot;consensus&quot;</span>)</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="ex">jq</span> -c . <span class="kw">|</span> <span class="kw">{</span> <span class="st">&quot;at&quot;</span>: <span class="ex">.at</span>, <span class="st">&quot;val&quot;</span>: .data.H <span class="kw">}</span></span></code></pre></div>
</section>
<section id="bash" class="level2">
<h2>bash</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">find</span> -name all.js</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="kw">for</span> <span class="ex">j</span> in <span class="va">$(</span><span class="fu">find</span> -name all.js<span class="va">)</span><span class="kw">;</span> <span class="kw">do</span> <span class="fu">cp</span> -v /tmp/all.js <span class="va">$j</span><span class="kw">;</span> <span class="kw">done</span></span></code></pre></div>
</section>
</section>
</div>

<div class="row">
        <span class="date  text-right">
            <i class="fa fa-calenda"></i> Posted on March 24, 2018
        </span>
        <span class="tags text-right" style="width: 100%">
            <ul class="list-inline"><li><i class="fa fa-tags"></i></li><li><a href="../../tags/DevOps.html">DevOps</a></li><li><a href="../../tags/deployment.html">deployment</a></li><li><a href="../../tags/linux-setup.html">linux-setup</a></li></ul>
        </span>
</div>

            </div>
            <div id="footer" class="col-md-12">
                <div class="row"><hr /></div>

                <div class="row text-center">
                  powered by  <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>,
                                      <a href="https://en.wikipedia.org/wiki/Org-mode" target="_blank"> Org-mode</a>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="../../js/quotes.js">
        </script>
    </body>
</html>
