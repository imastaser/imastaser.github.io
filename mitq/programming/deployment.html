<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Rail+NGinx+PostgreSQL+Redis setup</title>
        <link rel="alternate" type="application/rss+xml" title="AV notes" href="../../rss.xml" />
        <link rel="shortcut icon" href="../../favicon.ico?v=2" type="image/x-icon" />
        <link rel="stylesheet" href="../../css/bootstrap.min.css" />
        <link rel="stylesheet" href="../../css/bootstrap-theme.min.css" />
        <link rel="stylesheet" href="../../css/default.css" />
        <link rel="stylesheet" href="../../css/syntax.css" />
          <link rel="stylesheet" href="../../css/quotes.css" />
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" />
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( { tex2jax: { inlineMath: [ ["\\(", "\\)"] ]
                                           , displayMath: [ ["\\[", "\\]" ] ]
                                           , processEscapes: true
                                           }
                              });



        </script>
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>

        <script type="text/javascript" src="../../js/jquery.min.js">
        </script>
        <script type="text/javascript" src="../../js/bootstrap.min.js">
        </script>

    </head>
    <body>
        <div class="container">


            <div id="header">

                <ul id="navigation" class="list-inline text-center">
                    <li class="logo"><a href="../../" class="home-link">ԳԼԽԱՎՈՐ</a></i>
                    <li><a href="../../hogi/">ՀՈԳԻ</a></li>
                    <li><a href="../../mitq/">ՄԻՏՔ</a></li>
                    <li><a href="../../marmin/">ՄԱՐՄԻՆ</a></li>
                    <li><a href="../../rss.xml"><i class="fa fa-rss"></i></a></li>
                    <!-- <li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li> -->
                </ul>
            </div>
            <div class="clear"></div>
            <!---->

  <div class="clear"></div>
<!--  <p style="font-size: 11px;"><strong>Ուշադրություն.</strong> <small>«իմաստասէր» բառը պետք է հասկանալ տառացի. ոչ որպէս փիլիսոփա իմաստով:</small></p> -->
            <div id="content">

               <!-- <div class="title text-center">
                    <h4>Rail+NGinx+PostgreSQL+Redis setup</h4>
                    <hr>
                </div> -->
                <div class="post-content">
<div id="TOC"><ul>
<li><a href="#todo">TODO</a></li>
<li><a href="#server-fingerprint-changes">server fingerprint changes</a></li>
<li><a href="#create-user">create user</a></li>
<li><a href="#nginx">Nginx</a></li>
<li><a href="#set-domain-or-subdomain">set domain or subdomain</a></li>
<li><a href="#lets-encrypt">Let’s Encrypt</a></li>
<li><a href="#installing-ruby-nodejs-more-packages-go-rails-instruction">Installing Ruby, Nodejs more packages <a href="https://gorails.com/setup/ubuntu/16.04">Go rails instruction</a></a></li>
<li><a href="#postgresql">PostgreSQL</a><ul>
<li><a href="#postgresql-hacks">postgresql hacks</a></li>
</ul></li>
<li><a href="#redis">Redis</a></li>
<li><a href="#mina">Mina</a><ul>
<li><a href="#install-mina-gem">install mina gem</a></li>
<li><a href="#some-commands-with-no-password">some commands with no password</a></li>
<li><a href="#deploy-with-mina">deploy with mina</a></li>
</ul></li>
<li><a href="#backup-gem">Backup gem</a></li>
</ul></div>
<section id="todo" class="level1">
<h1>TODO</h1>
<ul>
<li>Backup Letsencrypt folder</li>
<li>backup config files move to shared folder</li>
</ul>
</section>
<section id="server-fingerprint-changes" class="level1">
<h1>server fingerprint changes</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">ssh-keygen</span> -f <span class="st">&quot;/home/arthur/.ssh/known_hosts&quot;</span> -R <span class="op">&lt;</span>ip_address<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">ssh-keygen</span> -f <span class="st">&quot;/home/arthur/.ssh/known_hosts&quot;</span> -R <span class="op">&lt;</span>domain_name<span class="op">&gt;</span></a></code></pre></div>
</section>
<section id="create-user" class="level1">
<h1>create user</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="ex">adduser</span> deployer</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="fu">sudo</span> usermod -aG sudo deployer</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="fu">mkdir</span> /home/deployer/.ssh</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="fu">cp</span> .ssh/authorized_keys /home/deployer/.ssh/</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="fu">sudo</span> chown -R deployer:deployer /home/deployer/.ssh/</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co"># edit /etc/ssh/sshd_config</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="ex">...</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="ex">PasswordAuthentication</span> no</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="ex">...</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co"># allow from some hosts</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co"># Settings that override the global settings for matching IP addresses only</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="ex">Match</span> address 192.0.2.0/24</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  <span class="ex">PasswordAuthentication</span> yes</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="ex">service</span> ssh reload</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co"># on remote server check permission and set to if needed</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co"># chmod 700 .ssh</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co"># chmod 600 .ssh/authorized_keys</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="bu">logout</span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="fu">ssh</span> deployer@<span class="op">&lt;</span>ip_adddress<span class="op">&gt;</span></a></code></pre></div>
</section>
<section id="nginx" class="level1">
<h1>Nginx</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ex">https</span>://websiteforstudents.com/install-nginx-latest-version-ubuntu-16-10-17-04/</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># For the stable version, change mainline to stable.</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="op">&gt;</span> <span class="fu">sudo</span> sh -c <span class="st">'echo &quot;deb http://nginx.org/packages/mainline/ubuntu/ `lsb_release -cs` nginx&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list'</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="op">&gt;</span> <span class="fu">sudo</span> sh -c <span class="st">'echo &quot;deb-src http://nginx.org/packages/mainline/ubuntu/ `lsb_release -cs` nginx&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list'</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="op">&gt;</span> <span class="fu">wget</span> -q http://nginx.org/keys/nginx_signing.key -O - <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="op">&gt;</span> <span class="fu">sudo</span> apt -y update</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="op">&gt;</span> <span class="ex">apt-cache</span> policy nginx</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="op">&gt;</span> <span class="fu">sudo</span> apt install -y nginx</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="op">&gt;</span> <span class="ex">nginx</span> -v</a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="op">&gt;</span> <span class="fu">sudo</span> systemctl enable nginx</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="op">&gt;</span> <span class="fu">sudo</span> service nginx start</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="op">&gt;</span> <span class="ex">systemctl</span> status nginx</a></code></pre></div>
</section>
<section id="set-domain-or-subdomain" class="level1">
<h1>set domain or subdomain</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># add A-record to dns server</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="op">&gt;</span> <span class="fu">sudo</span> vi  /etc/hosts</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="ex">127.0.1.1</span> test.<span class="op">&lt;</span>domain_name<span class="op">&gt;</span> test</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="ex">127.0.0.1</span> localhost</a></code></pre></div>
</section>
<section id="lets-encrypt" class="level1">
<h1>Let’s Encrypt</h1>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"> <span class="ex">it</span> is easy to get certificate before you have the advacned nginx config for</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"> <span class="ex">your</span> site</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="op">&gt;</span> <span class="fu">sudo</span> add-apt-repository ppa:certbot/certbot</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="op">&gt;</span> <span class="fu">sudo</span> apt update -y</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="op">&gt;</span> <span class="fu">sudo</span> apt install -y python-certbot-nginx</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="op">&gt;</span> <span class="fu">sudo</span> systemctl reload nginx</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co"># verify the syntax of configurations</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="op">&gt;</span> <span class="fu">sudo</span> nginx -t</a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="op">&gt;</span> <span class="fu">sudo</span> certbot certonly --dry-run --nginx -d <span class="op">&lt;</span>domain_name<span class="op">&gt;</span> -d www.<span class="op">&lt;</span>domain_name<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co"># </span><span class="al">TODO</span><span class="co">: backup /etc/letsencrypt fodler</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="co"># configuration directory at /etc/letsencrypt. You should make a</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co"># secure backup of this folder now. This configuration directory will</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co"># also contain certificates and private keys obtained by Certbot so</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="co"># making regular backups of this folder is ideal.</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="co"># at first comment ssl parts from nginx config for the site we want to get  certificate</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co"># </span><span class="al">TODO</span><span class="co">: generate pre-certifiacation config for site</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="co"># enter email address, c - is canceling all process.</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="op">&gt;</span> <span class="fu">sudo</span> certbot --nginx -d <span class="op">&lt;</span>domain_name<span class="op">&gt;</span> -d www.<span class="op">&lt;</span>domain_name<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"></a>
<a class="sourceLine" id="cb5-22" data-line-number="22"><span class="op">&gt;</span> <span class="fu">sudo</span> certbot renew --dry-run</a></code></pre></div>
</section>
<section id="installing-ruby-nodejs-more-packages-go-rails-instruction" class="level1">
<h1>Installing Ruby, Nodejs more packages <a href="https://gorails.com/setup/ubuntu/16.04">Go rails instruction</a></h1>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="op">&gt;</span> <span class="ex">curl</span> -sL https://deb.nodesource.com/setup_8.x <span class="kw">|</span> <span class="fu">sudo</span> -E bash -</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="op">&gt;</span> <span class="ex">curl</span> -sS https://dl.yarnpkg.com/debian/pubkey.gpg <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="op">&gt;</span> <span class="bu">echo</span> <span class="st">&quot;deb https://dl.yarnpkg.com/debian/ stable main&quot;</span> <span class="kw">|</span> <span class="fu">sudo</span> tee /etc/apt/sources.list.d/yarn.list</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="op">&gt;</span> <span class="fu">sudo</span> apt -y update</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="op">&gt;</span> <span class="fu">sudo</span> apt -y  install git-core curl zlib1g-dev build-essential libssl-dev</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="op">&gt;</span> <span class="fu">sudo</span> apt -y install  libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="op">&gt;</span> <span class="fu">sudo</span> apt -y install  libcurl4-openssl-dev python-software-properties libffi-dev nodejs yarn</a></code></pre></div>
<p>Installing rbenv</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="op">&gt;</span> <span class="bu">cd</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="op">&gt;</span> <span class="fu">git</span> clone https://github.com/rbenv/rbenv.git ~/.rbenv</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="op">&gt;</span> <span class="bu">echo</span> <span class="st">'export PATH=&quot;$HOME/.rbenv/bin:$PATH&quot;'</span> <span class="op">&gt;&gt;</span> ~/.bashrc</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="op">&gt;</span> <span class="bu">echo</span> <span class="st">'eval &quot;$(rbenv init -)&quot;'</span> <span class="op">&gt;&gt;</span> ~/.bashrc</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="op">&gt;</span> <span class="bu">exec</span> <span class="va">$SHELL</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="op">&gt;</span> <span class="fu">git</span> clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="op">&gt;</span> <span class="bu">echo</span> <span class="st">'export PATH=&quot;$HOME/.rbenv/plugins/ruby-build/bin:$PATH&quot;'</span> <span class="op">&gt;&gt;</span> ~/.bashrc</a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="op">&gt;</span> <span class="bu">exec</span> <span class="va">$SHELL</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="op">&gt;</span> <span class="ex">rbenv</span> install 2.5.0</a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="op">&gt;</span> <span class="ex">rbenv</span> global 2.5.0</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="op">&gt;</span> <span class="ex">ruby</span> -v</a>
<a class="sourceLine" id="cb7-14" data-line-number="14"></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="op">&gt;</span> <span class="bu">echo</span> <span class="st">&quot;gem: --no-document&quot;</span> <span class="op">&gt;</span> ~/.gemrc</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="op">&gt;</span> <span class="ex">gem</span> install bundler</a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="op">&gt;</span> <span class="ex">rbenv</span> rehash</a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="op">&gt;</span> <span class="ex">gem</span> list rails</a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="op">&gt;</span> <span class="ex">gem</span> env home</a>
<a class="sourceLine" id="cb7-20" data-line-number="20"></a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="ex">Commands</span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22"><span class="op">&gt;</span> <span class="ex">rbenv</span> install -l <span class="co"># list of versions that you can choose to install.</span></a>
<a class="sourceLine" id="cb7-23" data-line-number="23"><span class="op">&gt;</span> <span class="ex">rbenv</span> versions <span class="co"># Lists all Ruby versions known to rbenv</span></a>
<a class="sourceLine" id="cb7-24" data-line-number="24"><span class="op">&gt;</span> <span class="ex">rbenv</span> version <span class="co"># Displays the currently active Ruby version</span></a></code></pre></div>
</section>
<section id="postgresql" class="level1">
<h1>PostgreSQL</h1>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="op">&gt;</span> <span class="fu">sudo</span> sh -c <span class="st">'echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main&quot; &gt;&gt; /etc/apt/sources.list.d/pgdg.list'</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="op">&gt;</span> <span class="fu">wget</span> -q https://www.postgresql.org/media/keys/ACCC4CF8.asc -O - <span class="kw">|</span> <span class="fu">sudo</span> apt-key add -</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="op">&gt;</span> <span class="fu">sudo</span> apt update -y</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="op">&gt;</span> <span class="fu">sudo</span> apt -y install postgresql postgresql-contrib libpq-dev</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co"># add user auth</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="op">&gt;</span> <span class="fu">sudo</span> vi /etc/postgresql/10//main/pg_hba.conf</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="bu">local</span>   <span class="op">&lt;</span><span class="ex">db_role</span><span class="op">&gt;</span> <span class="op">&lt;</span>db_name<span class="op">&gt;</span> peer</a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="op">&gt;</span> <span class="fu">sudo</span> systemctl status  postgresql</a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="op">&gt;</span> <span class="fu">sudo</span> systemctl enable  postgresql</a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="op">&gt;</span> <span class="fu">sudo</span> systemctl restart postgresql</a></code></pre></div>
<p>create db user, set postgres password</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="op">&gt;</span> <span class="fu">sudo</span> su postgres</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="op">&gt;</span> <span class="ex">psql</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co"># \password -- set password for psotgres</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="op">&lt;</span><span class="ex">your_password</span> for super user<span class="op">&gt;</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="op">&gt;</span> <span class="ex">create</span> user iot with password <span class="st">'yourpass'</span> createdb superuser<span class="kw">;</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co"># \du -- list users</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co"># \q</span></a></code></pre></div>
<section id="postgresql-hacks" class="level2">
<h2>postgresql hacks</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="op">&gt;</span> <span class="ex">SELECT</span> pg_terminate_backend(pg_stat_activity.pid) <span class="ex">FROM</span> pg_stat_activity</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="ex">WHERE</span> pg_stat_activity.datname = <span class="st">'iothub_production;</span></a></code></pre></div>
</section>
</section>
<section id="redis" class="level1">
<h1>Redis</h1>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="ex">---------Install</span> build and test dependencies: ------</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="fu">sudo</span> apt -y update</a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="fu">sudo</span> apt -y full-upgrade</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># make test required tcl to run</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="fu">sudo</span> apt-get -y install build-essential tcl</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="ex">---------Set</span> up redis: -------</a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#Download latest copy via this link or with this</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="fu">mkdir</span> Downloads</a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="bu">cd</span> Downloads</a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="ex">curl</span> -O http://download.redis.io/redis-stable.tar.gz</a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="fu">tar</span> xzvf redis-stable.tar.gz</a>
<a class="sourceLine" id="cb11-13" data-line-number="13"></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="bu">cd</span> redis-stable</a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="fu">make</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="fu">make</span> test</a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="fu">sudo</span> make install</a>
<a class="sourceLine" id="cb11-18" data-line-number="18"></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="ex">------</span> Configure redis: -------</a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#Create configuration directory:</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="fu">sudo</span> mkdir /etc/redis</a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="co"># Move sample redis configuration file:</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="fu">sudo</span> cp ~/Downloads/redis-stable/redis.conf /etc/redis</a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="fu">sudo</span> vi /etc/redis/redis.conf</a>
<a class="sourceLine" id="cb11-25" data-line-number="25"><span class="co">#set dir for persistent data dump, for log</span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="ex">supervised</span> systemd</a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="fu">dir</span> /var/redis</a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="ex">logfile</span> /var/redis/redis.log</a>
<a class="sourceLine" id="cb11-29" data-line-number="29"></a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="ex">------</span> Set up the systemd unit file:------</a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="co">#create file</span></a>
<a class="sourceLine" id="cb11-32" data-line-number="32"><span class="fu">sudo</span> vi /etc/systemd/system/redis.service</a>
<a class="sourceLine" id="cb11-33" data-line-number="33"></a>
<a class="sourceLine" id="cb11-34" data-line-number="34"><span class="co"># add to file</span></a>
<a class="sourceLine" id="cb11-35" data-line-number="35">[<span class="ex">Unit</span>]</a>
<a class="sourceLine" id="cb11-36" data-line-number="36"><span class="va">Description=</span>Redis <span class="ex">In-Memory</span> Data Store</a>
<a class="sourceLine" id="cb11-37" data-line-number="37"><span class="va">After=</span>network.target</a>
<a class="sourceLine" id="cb11-38" data-line-number="38"></a>
<a class="sourceLine" id="cb11-39" data-line-number="39">[<span class="ex">Service</span>]</a>
<a class="sourceLine" id="cb11-40" data-line-number="40"><span class="va">User=</span>redis</a>
<a class="sourceLine" id="cb11-41" data-line-number="41"><span class="va">Group=</span>redis</a>
<a class="sourceLine" id="cb11-42" data-line-number="42"><span class="va">ExecStart=</span>/usr/local/bin/redis-server <span class="ex">/etc/redis/redis.conf</span></a>
<a class="sourceLine" id="cb11-43" data-line-number="43"><span class="va">ExecStop=</span>/usr/local/bin/redis-cli <span class="ex">shutdown</span></a>
<a class="sourceLine" id="cb11-44" data-line-number="44"><span class="va">Restart=</span>always</a>
<a class="sourceLine" id="cb11-45" data-line-number="45"></a>
<a class="sourceLine" id="cb11-46" data-line-number="46">[<span class="ex">Install</span>]</a>
<a class="sourceLine" id="cb11-47" data-line-number="47"><span class="va">WantedBy=</span>multi-user.target</a>
<a class="sourceLine" id="cb11-48" data-line-number="48"></a>
<a class="sourceLine" id="cb11-49" data-line-number="49"><span class="ex">-----</span>––––-----–– Set up redis user, groups and directories: –––</a>
<a class="sourceLine" id="cb11-50" data-line-number="50"><span class="co"># if /etc/systemd/system/redis.service cahnged</span></a>
<a class="sourceLine" id="cb11-51" data-line-number="51"><span class="fu">sudo</span> systemctl daemon-reload</a>
<a class="sourceLine" id="cb11-52" data-line-number="52"><span class="co"># create redis user and group with same ID but no home directory:</span></a>
<a class="sourceLine" id="cb11-53" data-line-number="53"></a>
<a class="sourceLine" id="cb11-54" data-line-number="54"><span class="fu">sudo</span> adduser --system --group --no-create-home redis</a>
<a class="sourceLine" id="cb11-55" data-line-number="55"><span class="fu">sudo</span> mkdir /var/redis   # create directory</a>
<a class="sourceLine" id="cb11-56" data-line-number="56"><span class="fu">sudo</span> chown redis:redis /var/redis   # make redis own /var/redis</a>
<a class="sourceLine" id="cb11-57" data-line-number="57"><span class="fu">sudo</span> chmod 770 /var/redis   # adjust permission</a>
<a class="sourceLine" id="cb11-58" data-line-number="58"></a>
<a class="sourceLine" id="cb11-59" data-line-number="59"><span class="fu">sudo</span> systemctl enable redis <span class="co"># Enable redis to start at boot:</span></a>
<a class="sourceLine" id="cb11-60" data-line-number="60"><span class="fu">sudo</span> systemctl start redis</a>
<a class="sourceLine" id="cb11-61" data-line-number="61"></a>
<a class="sourceLine" id="cb11-62" data-line-number="62"><span class="co">#other commands</span></a>
<a class="sourceLine" id="cb11-63" data-line-number="63"><span class="ex">systemctl</span> status redis</a>
<a class="sourceLine" id="cb11-64" data-line-number="64"><span class="fu">sudo</span> systemctl restart redis</a>
<a class="sourceLine" id="cb11-65" data-line-number="65"></a>
<a class="sourceLine" id="cb11-66" data-line-number="66"><span class="ex">-------</span> Enable redis to start at boot:------</a>
<a class="sourceLine" id="cb11-67" data-line-number="67"><span class="fu">sudo</span> systemctl enable redis</a>
<a class="sourceLine" id="cb11-68" data-line-number="68"></a>
<a class="sourceLine" id="cb11-69" data-line-number="69"><span class="ex">-----------------</span> Test instance: ------------</a>
<a class="sourceLine" id="cb11-70" data-line-number="70"><span class="ex">redis-cli</span></a>
<a class="sourceLine" id="cb11-71" data-line-number="71"><span class="fu">ping</span></a>
<a class="sourceLine" id="cb11-72" data-line-number="72"><span class="kw">set</span> <span class="bu">test</span> <span class="st">&quot;It's working!&quot;</span></a>
<a class="sourceLine" id="cb11-73" data-line-number="73"><span class="ex">get</span> test</a>
<a class="sourceLine" id="cb11-74" data-line-number="74"><span class="bu">exit</span></a>
<a class="sourceLine" id="cb11-75" data-line-number="75"><span class="fu">sudo</span> systemctl restart redis</a>
<a class="sourceLine" id="cb11-76" data-line-number="76"><span class="ex">--</span>–– FIX Warnings ––-</a>
<a class="sourceLine" id="cb11-77" data-line-number="77"></a>
<a class="sourceLine" id="cb11-78" data-line-number="78"><span class="ex">---</span> WARNING overcommit_memory is set to 0</a>
<a class="sourceLine" id="cb11-79" data-line-number="79"><span class="fu">sudo</span> nano /etc/sysctl.conf</a>
<a class="sourceLine" id="cb11-80" data-line-number="80"><span class="ex">vm.overcommit_memory</span>=1  #add this line to press wornix</a>
<a class="sourceLine" id="cb11-81" data-line-number="81"></a>
<a class="sourceLine" id="cb11-82" data-line-number="82"><span class="co"># run on trminal as well</span></a>
<a class="sourceLine" id="cb11-83" data-line-number="83"><span class="fu">sudo</span> sysctl vm.overcommit_memory=1</a>
<a class="sourceLine" id="cb11-84" data-line-number="84"></a>
<a class="sourceLine" id="cb11-85" data-line-number="85"><span class="ex">---</span> The TCP backlog setting of 511 cannot be enforced because</a>
<a class="sourceLine" id="cb11-86" data-line-number="86"><span class="ex">----</span> /proc/sys/net/core/somaxconn is set to the lower value of 128</a>
<a class="sourceLine" id="cb11-87" data-line-number="87"></a>
<a class="sourceLine" id="cb11-88" data-line-number="88"><span class="fu">sudo</span> nano /etc/rc.local</a>
<a class="sourceLine" id="cb11-89" data-line-number="89"><span class="ex">sysctl</span> -w net.core.somaxconn=65535 <span class="co"># add this line</span></a>
<a class="sourceLine" id="cb11-90" data-line-number="90"></a>
<a class="sourceLine" id="cb11-91" data-line-number="91"><span class="co"># run on trminal as well</span></a>
<a class="sourceLine" id="cb11-92" data-line-number="92"><span class="fu">sudo</span> sysctl -w net.core.somaxconn=65535</a></code></pre></div>
</section>
<section id="mina" class="level1">
<h1>Mina</h1>
<section id="install-mina-gem" class="level2">
<h2>install mina gem</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="op">&gt;</span> <span class="ex">gem</span> instal mina</a></code></pre></div>
</section>
<section id="some-commands-with-no-password" class="level2">
<h2>some commands with no password</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb13-1" data-line-number="1"> <span class="op">&gt;</span> <span class="fu">sudo</span> visudo</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"> <span class="ex">or</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"> <span class="op">&gt;</span> <span class="fu">sudo</span> vi /etc/sudoers</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"> <span class="bu">shift</span>+G</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"> ՈՒշադրություն, գրել վերջում</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"> <span class="co"># IMPORTANT!!!  add at the end</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"> <span class="ex">deployer</span> ALL=(ALL) <span class="ex">NOPASSWD</span>: /bin/ln</a>
<a class="sourceLine" id="cb13-8" data-line-number="8"> <span class="ex">deployer</span> ALL=(ALL) <span class="ex">NOPASSWD</span>: /bin/chmod</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"> <span class="ex">deployer</span> ALL=(ALL) <span class="ex">NOPASSWD</span>: /bin/cp</a>
<a class="sourceLine" id="cb13-10" data-line-number="10"></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"> :<span class="ex">wq</span>!</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"> <span class="co">#https://github.com/mina-deploy/mina/issues/234#issuecomment-57242061</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="op">&gt;</span> <span class="fu">sudo</span> service ssh reload</a></code></pre></div>
</section>
<section id="deploy-with-mina" class="level2">
<h2>deploy with mina</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="op">&gt;</span> <span class="ex">mina</span> test setup</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co"># at frist time uncomment schema_load, then comment</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="op">&gt;</span> <span class="ex">mina</span> test deploy</a></code></pre></div>
</section>
</section>
<section id="backup-gem" class="level1">
<h1>Backup gem</h1>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="op">&gt;</span> <span class="ex">gem</span> install backup -v5.0.0.beta.2</a></code></pre></div>
</section>
</div>

<div class="row">
        <span class="date  text-right">
            <i class="fa fa-calenda"></i> Posted on March 24, 2018
        </span>
        <span class="tags text-right" style="width: 100%">
            <ul class="list-inline"><li><i class="fa fa-tags"></i></li><li><a href="../../tags/DevOps.html">DevOps</a></li><li><a href="../../tags/deployment.html">deployment</a></li><li><a href="../../tags/linux-setup.html">linux-setup</a></li></ul>
        </span>
</div>

            </div>
            <div id="footer" class="col-md-12">
                <div class="row"><hr /></div>

                <div class="row text-center">
                    powered by  <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="../../js/quotes.js">
        </script>
    </body>
</html>
